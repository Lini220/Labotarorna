name: Task API CI/CD Pipeline

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build_test_and_deploy:
    runs-on: ubuntu-latest
    
    # Кроки конвеєра:
    steps:
      - name: 1. Checkout Code (Отримання коду)
        uses: actions/checkout@v4

      - name: 2. Setup Docker (Підготовка Docker)
        uses: docker/setup-buildx-action@v3
        
      - name: 3. Build & Run Services (Збірка та запуск ПЗ та АЗ)
        run: |
          echo "Starting Docker Compose Build and Run..."
          docker compose up --build -d
          
      - name: 4. Wait for API to Start (Надійне очікування Flask-API)
        run: |
          echo "Starting health check on API..."
          for i in $(seq 1 10); do
            response=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:5000/api/tasks || true)
            if [ "$response" -eq 200 ]; then
              echo "API is ready on port 5000!"
              exit 0
            fi
            echo "Attempt $i: Waiting for API to be ready on port 5000 (status: $response)..."
            sleep 5
          done
          echo "API failed to start within 50 seconds."
          exit 1

      - name: 5. Extra delay for API stability (Додаткова пауза)
        run: |
          echo "Waiting 5 seconds for full API stability..."
          sleep 5
        
      - name: 6. Run PyTest (Тестування функціональності)
        run: |
          echo "--- Starting PyTest ---"
          docker exec app-api pytest test_api.py -v

      - name: 7. Run Pylint Check (Статичний аналіз)
        run: |
          echo "--- Starting Pylint Check ---"
          docker exec app-api pylint app.py --fail-under=9.0
        
      - name: 8. Deploy Simulation (Імітація розгортання)
        run: |
          echo "Deployment succeeded: Container image built, tested, and validated."
          echo "Ready for production rollout."
        
      - name: 9. Stop Services (Очищення середовища)
        if: always()
        run: |
          echo "Cleaning up Docker services..."
          docker compose down